---
/**
 * Blog - Categoría (Diseño Minimalista)
 * @file src/pages/es/blog/categoria/[slug].astro
 */
import Layout from "@/layouts/Layout.astro";
import {
  getBlogPosts,
  getBlogPostsByCategory,
  getFeaturedImageUrl,
  calculateReadingTime,
} from "@/lib/blog.js";

const lang = "es";

const t = {
  blog: "Blog",
  article: "artículo",
  articles: "artículos",
  minRead: "min",
  noPosts: "No hay artículos en esta categoría",
  viewAll: "Todos",
  backToBlog: "Volver al blog",
};

// Obtener todos los posts del idioma para extraer categorías
const allPosts = await getBlogPosts(lang);

// Extraer categorías SOLO de los posts del idioma actual
const categoriesMap = new Map();
allPosts.forEach((post: any) => {
  post.blogCategories?.nodes?.forEach((cat: any) => {
    if (!categoriesMap.has(cat.slug)) {
      categoriesMap.set(cat.slug, { ...cat, count: 1 });
    } else {
      categoriesMap.get(cat.slug).count++;
    }
  });
});
const categories = Array.from(categoriesMap.values());

export async function getStaticPaths() {
  const allPosts = await getBlogPosts("es");

  const categoriesMap = new Map();
  allPosts.forEach((post: any) => {
    post.blogCategories?.nodes?.forEach((cat: any) => {
      if (!categoriesMap.has(cat.slug)) {
        categoriesMap.set(cat.slug, { ...cat, count: 1 });
      } else {
        categoriesMap.get(cat.slug).count++;
      }
    });
  });

  const categories = Array.from(categoriesMap.values());

  return categories.map((cat: any) => ({
    params: { slug: cat.slug },
    props: { category: cat },
  }));
}

const { slug } = Astro.params;
const { category } = Astro.props as { category: any };

const posts = await getBlogPostsByCategory(slug, lang);

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}

function getReadingTime(post: any): number {
  return (
    post.blogSeo?.readingTime ||
    calculateReadingTime(post.content || post.excerpt || "")
  );
}

const alternateUrls = [
  { lang: "es", url: `/es/blog/categoria/${slug}` },
  { lang: "en", url: `/en/blog/category/${slug}` },
  { lang: "fr", url: `/fr/blog/categorie/${slug}` },
  { lang: "ca", url: `/ca/blog/categoria/${slug}` },
  { lang: "pt-br", url: `/pt-br/blog/categoria/${slug}` },
];
---

<Layout
  title={`${category.name} | Blog | RayGold`}
  description={`Artículos sobre ${category.name.toLowerCase()} - RayGold ERP para Joyería`}
  lang={lang}
  alternateUrls={alternateUrls as any}
>
  <main class="page">
    <!-- Header minimalista -->
    <header class="header">
      <div class="container">
        <a href={`/${lang}/blog`} class="back">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M19 12H5M12 19l-7-7 7-7"></path>
          </svg>
          {t.blog}
        </a>

        <div class="title-block">
          <span class="label">Categoría</span>
          <h1>{category.name}</h1>
          <p>{posts.length} {posts.length === 1 ? t.article : t.articles}</p>
        </div>

        <!-- Pills de categorías -->
        <nav class="categories">
          <a href={`/${lang}/blog`} class="pill">{t.viewAll}</a>
          {
            categories.map((cat: any) => (
              <a
                href={`/${lang}/blog/categoria/${cat.slug}`}
                class:list={["pill", { active: cat.slug === slug }]}
              >
                {cat.name}
              </a>
            ))
          }
        </nav>
      </div>
    </header>

    <!-- Artículos -->
    <section class="articles">
      <div class="container">
        {
          posts.length > 0 ? (
            <div class="grid">
              {posts.map((post: any, index: number) => (
                <article class="card">
                  <a href={`/${lang}/blog/${post.slug}`}>
                    <div class="image">
                      {getFeaturedImageUrl(post) ? (
                        <img
                          src={getFeaturedImageUrl(post)}
                          alt={post.title}
                          loading={index < 3 ? "eager" : "lazy"}
                        />
                      ) : (
                        <div class="placeholder">
                          <svg
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                          >
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <circle cx="8.5" cy="8.5" r="1.5" />
                            <path d="M21 15l-5-5L5 21" />
                          </svg>
                        </div>
                      )}
                    </div>
                    <div class="content">
                      <h2>{post.title}</h2>
                      <div class="meta">
                        <time>{formatDate(post.date)}</time>
                        <span class="sep">·</span>
                        <span>
                          {getReadingTime(post)} {t.minRead}
                        </span>
                      </div>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          ) : (
            <div class="empty">
              <p>{t.noPosts}</p>
              <a href={`/${lang}/blog`}>{t.backToBlog}</a>
            </div>
          )
        }
      </div>
    </section>
  </main>
</Layout>

<style>
  /* Reset y variables */
  .page {
    --gold: #c9a227;
    --dark: #111;
    --gray-600: #525252;
    --gray-400: #a3a3a3;
    --gray-200: #e5e5e5;
    --gray-100: #f5f5f5;
    --white: #fff;
    background: var(--white);
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  /* ===== HEADER ===== */
  .header {
    padding: 3rem 0 2.5rem;
    border-bottom: 1px solid var(--gray-200);
  }

  .back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--gray-400);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 2rem;
    transition: color 0.2s;
  }

  .back:hover {
    color: var(--gold);
  }

  .title-block {
    margin-bottom: 2rem;
  }

  .label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 0.5rem;
  }

  .title-block h1 {
    font-size: 3rem;
    font-weight: 600;
    letter-spacing: -0.03em;
    color: var(--dark);
    margin: 0 0 0.5rem 0;
    line-height: 1.1;
  }

  .title-block p {
    font-size: 1rem;
    color: var(--gray-400);
    margin: 0;
  }

  /* Categorías */
  .categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .pill {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--gray-600);
    text-decoration: none;
    background: var(--gray-100);
    border-radius: 100px;
    transition: all 0.2s;
  }

  .pill:hover {
    background: var(--gray-200);
    color: var(--dark);
  }

  .pill.active {
    background: var(--dark);
    color: var(--white);
  }

  /* ===== ARTÍCULOS ===== */
  .articles {
    padding: 3rem 0 5rem;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2.5rem 2rem;
  }

  /* Card */
  .card a {
    display: block;
    text-decoration: none;
  }

  .card .image {
    position: relative;
    aspect-ratio: 3/2;
    border-radius: 12px;
    overflow: hidden;
    background: var(--gray-100);
    margin-bottom: 1rem;
  }

  .card .image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .card a:hover .image img {
    transform: scale(1.03);
  }

  .card .placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-400);
  }

  .card .content {
    padding: 0 0.25rem;
  }

  .card h2 {
    font-size: 1.0625rem;
    font-weight: 600;
    line-height: 1.4;
    color: var(--dark);
    margin: 0 0 0.625rem 0;
    transition: color 0.2s;
  }

  .card a:hover h2 {
    color: var(--gold);
  }

  .card .meta {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    color: var(--gray-400);
  }

  .card .sep {
    color: var(--gray-200);
  }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 5rem 2rem;
  }

  .empty p {
    color: var(--gray-400);
    font-size: 1.125rem;
    margin-bottom: 1.5rem;
  }

  .empty a {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: var(--dark);
    color: var(--white);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .empty a:hover {
    background: var(--gold);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 900px) {
    .grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem 1.5rem;
    }
  }

  @media (max-width: 600px) {
    .container {
      padding: 0 1.25rem;
    }

    .header {
      padding: 2rem 0 2rem;
    }

    .title-block h1 {
      font-size: 2rem;
    }

    .grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .card .image {
      border-radius: 10px;
    }
  }
</style>
