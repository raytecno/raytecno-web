---
/**
 * Blog - Artículos por Categoría (Español)
 * @file src/pages/es/blog/categoria/[slug].astro
 */
import Layout from "@/layouts/Layout.astro";
import {
  getBlogPostsByCategory,
  getBlogCategories,
  getFeaturedImageUrl,
  calculateReadingTime,
} from "@/lib/blog.js";

const lang = "es";

// Generar rutas estáticas
export async function getStaticPaths() {
  const categories = await getBlogCategories();
  return categories.map((cat) => ({
    params: { slug: cat.slug },
    props: { category: cat },
  }));
}

const { slug } = Astro.params;
const { category } = Astro.props;

// Traducciones
const t = {
  title: "Blog",
  metaTitle: `${category?.name || "Categoría"} | Blog RayGold`,
  metaDescription: `Artículos sobre ${category?.name?.toLowerCase() || "joyería"} en el blog de RayGold ERP.`,
  allPosts: `Artículos en "${category?.name || "Categoría"}"`,
  categories: "Categorías",
  minRead: "min de lectura",
  noPosts: "No hay artículos en esta categoría",
  backToBlog: "Ver todos los artículos",
  ctaTitle: "¿Quieres ver RayGold en acción?",
  ctaText: "Solicita una demo personalizada para tu negocio.",
  ctaButton: "Solicitar Demo",
};

// Obtener datos
const [posts, categories] = await Promise.all([
  getBlogPostsByCategory(slug, lang),
  getBlogCategories(),
]);

// URLs alternativas
const alternateUrls = [
  { lang: "es", url: `/es/blog/categoria/${slug}` },
  { lang: "en", url: `/en/blog/category/${slug}` },
  { lang: "fr", url: `/fr/blog/categorie/${slug}` },
  { lang: "ca", url: `/ca/blog/categoria/${slug}` },
  { lang: "pt-br", url: `/pt-br/blog/categoria/${slug}` },
];

// Formatear fecha
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString("es-ES", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Obtener tiempo de lectura
function getReadingTime(post) {
  return (
    post.blogSeo?.readingTime ||
    calculateReadingTime(post.content || post.excerpt)
  );
}
---

<Layout
  title={t.metaTitle}
  description={t.metaDescription}
  lang={lang}
  alternateUrls={alternateUrls}
>
  <div class="blog-page">
    <!-- Hero -->
    <section class="blog-hero">
      <div class="container">
        <nav class="breadcrumb-hero">
          <a href={`/${lang}/blog`}>Blog</a>
          <span>/</span>
          <span>{category?.name || "Categoría"}</span>
        </nav>
        <h1>{category?.name || "Categoría"}</h1>
        <p>
          {posts.length} artículo{posts.length !== 1 ? "s" : ""} en esta categoría
        </p>
      </div>
    </section>

    <!-- Listado -->
    <section class="posts-section">
      <div class="container">
        <div class="posts-layout">
          <!-- Grid de Posts -->
          <div class="posts-grid">
            <div class="section-header">
              <h2>{t.allPosts}</h2>
              <a href={`/${lang}/blog`} class="back-link">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="m15 18-6-6 6-6"></path>
                </svg>
                {t.backToBlog}
              </a>
            </div>

            {
              posts.length > 0 ? (
                <div class="grid">
                  {posts.map((post) => (
                    <article class="post-card">
                      {getFeaturedImageUrl(post) && (
                        <a
                          href={`/${lang}/blog/${post.slug}`}
                          class="post-image"
                        >
                          <img
                            src={getFeaturedImageUrl(post)}
                            alt={post.title}
                            loading="lazy"
                          />
                        </a>
                      )}
                      <div class="post-content">
                        <span class="category-badge">{category?.name}</span>
                        <h3>
                          <a href={`/${lang}/blog/${post.slug}`}>
                            {post.title}
                          </a>
                        </h3>
                        <p set:html={post.excerpt} />
                        <div class="post-footer">
                          <time datetime={post.date}>
                            {formatDate(post.date)}
                          </time>
                          <span>
                            {getReadingTime(post)} {t.minRead}
                          </span>
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              ) : (
                <div class="no-posts">
                  <p>{t.noPosts}</p>
                  <a href={`/${lang}/blog`} class="btn-back">
                    {t.backToBlog}
                  </a>
                </div>
              )
            }
          </div>

          <!-- Sidebar -->
          <aside class="sidebar">
            <!-- Categorías -->
            {
              categories.length > 0 && (
                <div class="sidebar-widget">
                  <h3>{t.categories}</h3>
                  <ul class="categories-list">
                    {categories.map((cat) => (
                      <li>
                        <a
                          href={`/${lang}/blog/categoria/${cat.slug}`}
                          class:list={[{ active: cat.slug === slug }]}
                        >
                          {cat.name}
                          <span class="count">({cat.count || 0})</span>
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )
            }

            <!-- CTA -->
            <div class="sidebar-cta">
              <h3>{t.ctaTitle}</h3>
              <p>{t.ctaText}</p>
              <a href={`/${lang}/contacto`} class="btn-cta">{t.ctaButton}</a>
            </div>
          </aside>
        </div>
      </div>
    </section>
  </div>
</Layout>

<style>
  .blog-page {
    --primary: #c9a227;
    --primary-dark: #b8931f;
    --text: #1a1a1a;
    --text-light: #666;
    --bg-light: #f8f9fa;
    --border: #e5e5e5;
    background: white;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Hero */
  .blog-hero {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: white;
    padding: 3rem 0;
    text-align: center;
  }

  .breadcrumb-hero {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    opacity: 0.8;
  }

  .breadcrumb-hero a {
    color: white;
    text-decoration: none;
  }

  .breadcrumb-hero a:hover {
    text-decoration: underline;
  }

  .blog-hero h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }

  .blog-hero p {
    font-size: 1rem;
    opacity: 0.8;
  }

  /* Posts Section */
  .posts-section {
    padding: 4rem 0;
  }

  .posts-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 3rem;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .section-header h2 {
    font-size: 1.5rem;
    color: var(--text);
    margin: 0;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-light);
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--primary);
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
  }

  .post-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    transition:
      transform 0.3s,
      box-shadow 0.3s;
  }

  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
  }

  .post-image {
    display: block;
    height: 180px;
    overflow: hidden;
  }

  .post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .post-card:hover .post-image img {
    transform: scale(1.05);
  }

  .post-content {
    padding: 1.25rem;
  }

  .category-badge {
    display: inline-block;
    background: var(--primary);
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .post-content h3 {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .post-content h3 a {
    color: var(--text);
    text-decoration: none;
  }

  .post-content h3 a:hover {
    color: var(--primary);
  }

  .post-content p {
    color: var(--text-light);
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 1rem;
  }

  .post-footer {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text-light);
    padding-top: 1rem;
    border-top: 1px solid var(--border);
  }

  .no-posts {
    text-align: center;
    padding: 3rem;
    background: var(--bg-light);
    border-radius: 12px;
  }

  .no-posts p {
    color: var(--text-light);
    margin-bottom: 1.5rem;
  }

  .btn-back {
    display: inline-block;
    background: var(--primary);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
  }

  .btn-back:hover {
    background: var(--primary-dark);
  }

  /* Sidebar */
  .sidebar-widget {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
  }

  .sidebar-widget h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--text);
  }

  .categories-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .categories-list li {
    margin-bottom: 0.5rem;
  }

  .categories-list a {
    display: flex;
    justify-content: space-between;
    color: var(--text);
    text-decoration: none;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    transition: color 0.2s;
  }

  .categories-list a:hover {
    color: var(--primary);
  }

  .categories-list a.active {
    color: var(--primary);
    font-weight: 600;
  }

  .categories-list .count {
    color: var(--text-light);
    font-size: 0.85rem;
  }

  .sidebar-cta {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
  }

  .sidebar-cta h3 {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
  }

  .sidebar-cta p {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 1rem;
  }

  .btn-cta {
    display: inline-block;
    background: var(--primary);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.3s;
  }

  .btn-cta:hover {
    background: var(--primary-dark);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .posts-layout {
      grid-template-columns: 1fr;
    }

    .sidebar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
  }

  @media (max-width: 768px) {
    .blog-hero h1 {
      font-size: 2rem;
    }

    .grid {
      grid-template-columns: 1fr;
    }

    .sidebar {
      grid-template-columns: 1fr;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
