---
/**
 * SEO.astro - Componente SEO unificado para RayGold
 * 
 * CORRECCIONES SEO (Febrero 2026 - Post Screaming Frog):
 * - Canonical URLs SIN trailing slash (Azure SWA elimina la /)
 * - Hreflang URLs SIN trailing slash (coherente con canonicals)
 * - x-default apunta a la versión INGLESA de la página actual
 * - Páginas noindex NO generan hreflang
 * - Páginas noindex NO aparecen en hreflang de otras páginas
 * 
 * Incluye:
 * - Meta tags básicos
 * - Open Graph (Facebook, WhatsApp, LinkedIn)
 * - Twitter Cards
 * - hreflang para multiidioma
 * - Schema.org JSON-LD
 * - Breadcrumbs dinámicos
 */

import { type Lang } from "@/config/pages";

// ============================================
// CONFIGURACIÓN DE LA EMPRESA
// ============================================
const COMPANY = {
  name: "RayGold ERP",
  legalName: "Raytecno BCN SL",
  
  // Dominios - TODO va a .es (el .com redirige)
  primaryDomain: "https://www.raytecno.es",
  
  // Imágenes
  logo: "/images/logo.svg",
  defaultOgImage: "/images/og-default.jpg",
  
  // Contacto
  phone: "+34648088550",
  phoneDisplay: "+34 648 088 550",
  email: "info@raytecno.es",
  
  // Dirección
  address: {
    street: "Montgat",
    city: "Barcelona",
    region: "Cataluña",
    postalCode: "08390",
    country: "ES",
  },
  
  // Redes sociales
  social: {
    linkedin: "https://www.linkedin.com/in/raytecno-raytecno-062901117",
    twitter: "@raytecno",
  },
  
  // Colores
  themeColor: "#667eea",
  
  // Datos de la empresa
  foundingDate: "1990",
  
  // Reviews
  reviews: {
    enabled: true,
    ratingValue: "4.8",
    reviewCount: "150",
    bestRating: "5",
    worstRating: "1",
  },
};

// ============================================
// CONFIGURACIÓN POR IDIOMA
// ============================================
const LANG_CONFIG: Record<Lang, {
  locale: string;
  hreflang: string;
  languageName: string;
  defaultTitle: string;
  defaultDescription: string;
  defaultKeywords: string[];
  homeLabel: string;
}> = {
  es: {
    locale: "es_ES",
    hreflang: "es",
    languageName: "Spanish",
    defaultTitle: "RayGold - Software ERP para Joyería",
    defaultDescription: "Software de gestión integral para el sector joyero. ERP especializado con módulos de fabricación, trazabilidad de metales preciosos, control de mermas y más. +35 años de experiencia.",
    defaultKeywords: ["ERP joyería", "software joyería", "gestión joyería", "RayGold", "fabricación joyas", "control mermas oro", "trazabilidad metales preciosos", "Raytecno"],
    homeLabel: "Inicio",
  },
  en: {
    locale: "en_US",
    hreflang: "en",
    languageName: "English",
    defaultTitle: "RayGold - Jewelry ERP Software",
    defaultDescription: "Comprehensive management software for the jewelry industry. Specialized ERP with manufacturing modules, precious metal traceability, waste control and more. +35 years of experience.",
    defaultKeywords: ["jewelry ERP", "jewelry software", "jewelry management", "RayGold", "jewelry manufacturing", "gold waste control", "precious metal traceability", "Raytecno"],
    homeLabel: "Home",
  },
  fr: {
    locale: "fr_FR",
    hreflang: "fr",
    languageName: "French",
    defaultTitle: "RayGold - Logiciel ERP pour Bijouterie",
    defaultDescription: "Logiciel de gestion intégrale pour le secteur bijoutier. ERP spécialisé avec modules de fabrication, traçabilité des métaux précieux, contrôle des pertes et plus. +35 ans d'expérience.",
    defaultKeywords: ["ERP bijouterie", "logiciel bijouterie", "gestion bijouterie", "RayGold", "fabrication bijoux", "contrôle pertes or", "traçabilité métaux précieux", "Raytecno"],
    homeLabel: "Accueil",
  },
  ca: {
    locale: "ca_ES",
    hreflang: "ca",
    languageName: "Catalan",
    defaultTitle: "RayGold - Programari ERP per a Joieria",
    defaultDescription: "Programari de gestió integral per al sector joier. ERP especialitzat amb mòduls de fabricació, traçabilitat de metalls preciosos, control de pèrdues i més. +35 anys d'experiència.",
    defaultKeywords: ["ERP joieria", "programari joieria", "gestió joieria", "RayGold", "fabricació joies", "control pèrdues or", "traçabilitat metalls preciosos", "Raytecno"],
    homeLabel: "Inici",
  },
  "pt-br": {
    locale: "pt_BR",
    hreflang: "pt-BR",
    languageName: "Portuguese",
    defaultTitle: "RayGold - Software ERP para Joalheria",
    defaultDescription: "Software de gestão integral para o setor joalheiro. ERP especializado com módulos de fabricação, rastreabilidade de metais preciosos, controle de perdas e mais. +35 anos de experiência.",
    defaultKeywords: ["ERP joalheria", "software joalheria", "gestão joalheria", "RayGold", "fabricação joias", "controle perdas ouro", "rastreabilidade metais preciosos", "Raytecno"],
    homeLabel: "Início",
  },
};

// ============================================
// PROPS DEL COMPONENTE
// ============================================
interface Props {
  lang?: Lang;
  title?: string;
  description?: string;
  keywords?: string[];
  image?: string;
  type?: "website" | "article" | "product";
  noindex?: boolean;
  publishedTime?: string;
  modifiedTime?: string;
  alternateUrls?: { lang: Lang; url: string }[];
}

const {
  lang = "es",
  title,
  description,
  keywords,
  image,
  type = "website",
  noindex = false,
  publishedTime,
  modifiedTime,
  alternateUrls = [],
} = Astro.props;

// ============================================
// VARIABLES CALCULADAS
// ============================================
const config = LANG_CONFIG[lang] || LANG_CONFIG.es;

// Siempre usar el dominio principal .es
const siteDomain = COMPANY.primaryDomain;

// ============================================
// URL CANONICAL - SIN trailing slash
// Azure Static Web Apps elimina el trailing slash,
// así que la canonical debe coincidir con la URL real.
// ============================================
let currentPath = Astro.url.pathname;
// Eliminar trailing slash (excepto la raíz "/")
if (currentPath.length > 1 && currentPath.endsWith('/')) {
  currentPath = currentPath.slice(0, -1);
}
const canonicalUrl = `${siteDomain}${currentPath}`;

// Título
const fullTitle = title ? `${title} | ${COMPANY.name}` : config.defaultTitle;

// Descripción
const finalDescription = description || config.defaultDescription;

// Keywords
const finalKeywords = keywords || config.defaultKeywords;

// Imagen OG
const ogImage = image 
  ? (image.startsWith("http") ? image : `${siteDomain}${image}`)
  : `${siteDomain}${COMPANY.defaultOgImage}`;

// Logo absoluto
const logoUrl = `${siteDomain}${COMPANY.logo}`;

// ============================================
// FUNCIÓN HELPER: Eliminar trailing slash
// ============================================
function removeTrailingSlash(url: string): string {
  if (url === '/' || url.endsWith('://')) return url;
  return url.endsWith('/') ? url.slice(0, -1) : url;
}

// ============================================
// FUNCIÓN HELPER: Normalizar URL para hreflang
// Construye URL absoluta SIN trailing slash
// ============================================
function buildHreflangUrl(altUrl: string): string {
  // Si ya es absoluta, solo quitar trailing slash
  if (altUrl.startsWith('http')) {
    return removeTrailingSlash(altUrl);
  }
  // Si es relativa, construir con dominio
  const cleanPath = removeTrailingSlash(altUrl);
  return `${siteDomain}${cleanPath}`;
}

// ============================================
// FILTRAR ALTERNATE URLS
// Excluir de hreflang las páginas con noindex
// (cookies, privacidad, terminos)
// ============================================
const indexableAlternateUrls = noindex ? [] : alternateUrls;

// ============================================
// OBTENER URL INGLESA PARA X-DEFAULT
// Busca en alternateUrls la versión en inglés
// Si no existe, usa /en (home inglesa)
// ============================================
function getXDefaultUrl(): string {
  // Buscar la versión inglesa en alternateUrls
  const englishAlt = alternateUrls.find(alt => alt.lang === 'en');
  if (englishAlt) {
    return buildHreflangUrl(englishAlt.url);
  }
  // Fallback: home inglesa
  return `${siteDomain}/en`;
}

const xDefaultUrl = getXDefaultUrl();

// ============================================
// SCHEMA.ORG - ORGANIZATION
// ============================================
const schemaOrganization = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": COMPANY.legalName,
  "url": COMPANY.primaryDomain,
  "logo": logoUrl,
  "description": config.defaultDescription,
  "foundingDate": COMPANY.foundingDate,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": COMPANY.address.street,
    "addressLocality": COMPANY.address.city,
    "addressRegion": COMPANY.address.region,
    "postalCode": COMPANY.address.postalCode,
    "addressCountry": COMPANY.address.country,
  },
  "contactPoint": {
    "@type": "ContactPoint",
    "telephone": COMPANY.phone,
    "email": COMPANY.email,
    "contactType": "sales",
    "availableLanguage": ["Spanish", "English", "French", "Catalan", "Portuguese"],
  },
  "sameAs": [
    COMPANY.social.linkedin,
  ].filter(Boolean),
};

// ============================================
// SCHEMA.ORG - SOFTWARE APPLICATION
// ============================================
const schemaSoftware = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": COMPANY.name,
  "applicationCategory": "BusinessApplication",
  "operatingSystem": "Windows, Web",
  "description": finalDescription,
  "url": COMPANY.primaryDomain,
  "author": {
    "@type": "Organization",
    "name": COMPANY.legalName,
  },
  "offers": {
    "@type": "Offer",
    "price": "29",
    "priceCurrency": "EUR",
    "priceValidUntil": new Date(new Date().getFullYear() + 1, 11, 31).toISOString().split("T")[0],
    "availability": "https://schema.org/InStock",
  },
  ...(COMPANY.reviews.enabled && {
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": COMPANY.reviews.ratingValue,
      "reviewCount": COMPANY.reviews.reviewCount,
      "bestRating": COMPANY.reviews.bestRating,
      "worstRating": COMPANY.reviews.worstRating,
    },
  }),
};

// ============================================
// SCHEMA.ORG - WEBPAGE
// ============================================
const schemaWebPage = {
  "@context": "https://schema.org",
  "@type": type === "article" ? "Article" : "WebPage",
  "name": fullTitle,
  "description": finalDescription,
  "url": canonicalUrl,
  "image": ogImage,
  "inLanguage": config.hreflang,
  "isPartOf": {
    "@type": "WebSite",
    "name": COMPANY.name,
    "url": siteDomain,
  },
  ...(publishedTime && { "datePublished": publishedTime }),
  ...(modifiedTime && { "dateModified": modifiedTime }),
  ...(type === "article" && {
    "author": {
      "@type": "Organization",
      "name": COMPANY.legalName,
    },
  }),
};

// ============================================
// SCHEMA.ORG - BREADCRUMB
// URLs en breadcrumbs también sin trailing slash
// ============================================
const pathSegments = currentPath
  .split("/")
  .filter(Boolean)
  .filter(s => !["es", "en", "fr", "ca", "pt-br"].includes(s));

const breadcrumbItems = [
  {
    "@type": "ListItem",
    "position": 1,
    "name": config.homeLabel,
    "item": `${siteDomain}/${lang}`,
  },
  ...pathSegments.map((segment, index) => ({
    "@type": "ListItem",
    "position": index + 2,
    "name": segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, " "),
    "item": `${siteDomain}/${lang}/${pathSegments.slice(0, index + 1).join("/")}`,
  })),
];

const schemaBreadcrumb = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbItems,
};
---

<!-- ========================================
     META TAGS BÁSICOS
     ======================================== -->
<title>{fullTitle}</title>
<meta name="description" content={finalDescription} />
<meta name="keywords" content={finalKeywords.join(", ")} />
<meta name="author" content={COMPANY.legalName} />
<meta name="language" content={config.languageName} />

<!-- Robots -->
{noindex ? (
  <meta name="robots" content="noindex, nofollow" />
) : (
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
)}

<!-- Canonical - SIN trailing slash (Azure SWA lo elimina) -->
<link rel="canonical" href={canonicalUrl} />

<!-- ========================================
     HREFLANG (Multiidioma)
     - URLs SIN trailing slash (coherente con canonicals)
     - Solo se generan si la página NO tiene noindex
     - Esto evita "Canonical no indexable" en Screaming Frog
     ======================================== -->
{indexableAlternateUrls.map((alt) => (
  <link 
    rel="alternate" 
    hreflang={LANG_CONFIG[alt.lang]?.hreflang || alt.lang} 
    href={buildHreflangUrl(alt.url)} 
  />
))}

<!-- 
  x-default: Apunta a la versión INGLESA de la página actual
  - Si estamos en /es/precios → x-default = /en/pricing
  - Si estamos en /es/modulos → x-default = /en/modules
  - Solo se genera si hay alternateUrls y la página es indexable
-->
{indexableAlternateUrls.length > 0 && (
  <link 
    rel="alternate" 
    hreflang="x-default" 
    href={xDefaultUrl} 
  />
)}

<!-- ========================================
     OPEN GRAPH (Facebook, LinkedIn, WhatsApp)
     ======================================== -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={finalDescription} />
<meta property="og:image" content={ogImage} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content={fullTitle} />
<meta property="og:locale" content={config.locale} />
<meta property="og:site_name" content={COMPANY.name} />

<!-- Locales alternativos -->
{Object.entries(LANG_CONFIG)
  .filter(([code]) => code !== lang)
  .map(([_, conf]) => (
    <meta property="og:locale:alternate" content={conf.locale} />
  ))
}

<!-- Article meta (solo para blogs) -->
{type === "article" && publishedTime && (
  <meta property="article:published_time" content={publishedTime} />
)}
{type === "article" && modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime} />
)}

<!-- ========================================
     TWITTER CARDS
     ======================================== -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content={COMPANY.social.twitter} />
<meta name="twitter:creator" content={COMPANY.social.twitter} />
<meta name="twitter:url" content={canonicalUrl} />
<meta name="twitter:title" content={fullTitle} />
<meta name="twitter:description" content={finalDescription} />
<meta name="twitter:image" content={ogImage} />

<!-- ========================================
     TEMA Y COLORES
     ======================================== -->
<meta name="theme-color" content={COMPANY.themeColor} />
<meta name="msapplication-TileColor" content={COMPANY.themeColor} />

<!-- ========================================
     GEO TAGS (SEO Local)
     ======================================== -->
<meta name="geo.region" content="ES-CT" />
<meta name="geo.placename" content={COMPANY.address.city} />

<!-- ========================================
     FAVICON Y ICONOS
     ======================================== -->
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />

<!-- ========================================
     PRECONNECT (Rendimiento)
     ======================================== -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- ========================================
     SCHEMA.ORG JSON-LD
     ======================================== -->
<script type="application/ld+json" set:html={JSON.stringify(schemaOrganization)} />
<script type="application/ld+json" set:html={JSON.stringify(schemaWebPage)} />
<script type="application/ld+json" set:html={JSON.stringify(schemaBreadcrumb)} />
{type === "product" && (
  <script type="application/ld+json" set:html={JSON.stringify(schemaSoftware)} />
)}